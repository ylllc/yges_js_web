<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset="utf-8">
	<title>Yggdrasil Essense</title>
	<link href="main.css" rel="stylesheet">
</head>
<body onload="ipl_ready()"><div class=screen>
<header>
<a href="./index.html">Yggdrasil Essense</a> / 
WebSocket Example
<hr>
</header>
<main>
<h1 class="pagetitle">WebSocket Example</h1>
<noscript><div class="warning">(JavaScript required)</div></noscript>
<div id=mainboard class=main></div>
</main>
<footer>
<hr>
&copy; 2025 Yggdrasil Leaves, LLC.<br>
Repositories: 
<a target="_blank" href="https://github.com/ylllc/yges_js_web">[web]</a>
<a target="_blank" href="https://github.com/ylllc/yges_js_node">[Node.js]</a>
<a target="_blank" href="https://github.com/ylllc/yges_js_deno">[Deno]</a>
<a target="_blank" href="https://github.com/ylllc/yges_js_electron_builder">[Electron Bulider]</a>
<a target="_blank" href="https://github.com/ylllc/yges_js_electron_forge">[Electron Forge]</a>
</footer>
<div id=modules>
<script src="yges/ipl.js"></script>
</div>
<script><!--
let modules=YgEs.ToQHT(document.getElementById('modules'));
let mainboard=YgEs.ToQHT(document.getElementById('mainboard'));
mainboard.Clear();
let ipl_loading=YgEs.NewQHT({Target:mainboard,Tag:'div',Attr:{class:'warning'},Sub:['(IPL Loading...)']});
let log=null; // Logger 
let ws_cli=null; // WebSock 
let ws_driver=null; // Receiver 
let ws_transport=null; // Transport 
let ws_endpoint=null; // EndPoint 
let ws_protocol=null; // Protocol 

let gui_echo_content_recv=null;

const WSGuestEPN='WSGuest';

// payload definition (shared between server and client) 
const pld_specs={
	ECHO_REQ:{
		CallOnce:{
			// only 1 call until replied 
			Limit:true,
			// can call again after msec 
			Timeout:10000,
		},
	},
	ECHO_REP:{
		// unlock ECHO_REQ when received 
		UnlockOnce:['ECHO_REQ'],
	},
}

// WebSocket driver 
const drvopt={
	OnSend:(sender,rawdata,prop)=>{

		log.Trace('transport sending',rawdata);

		ws_cli.Send(rawdata);
	},
}

// WebSocket Transport 
const tpopt={
	PIDPrefix:'WebSockTest',
	PayloadSpecs:pld_specs,
	PayloadHooks:{
		ECHO_REP:{
			OnBound:(tp,payload,prop)=>{

				log.Trace('bound new Protocol',payload);

				return WSGuestEPN;
			},
			OnRespond:(tp,prot,payload,prop)=>{

				log.Trace('respond in Protocol '+prot.GetPID(),payload);

				gui_echo_content_recv.Element.value=payload.Body;

				// this Protocol is continued 
				return true;
			},
		},
	},
}

function ws_client_new(name,url,interval){

	let opt={
		// wait ms and auto reconnect when disconnected 
		AutoReconnectWait:5000, 

		OnConnected:(agent)=>{
			log.Info('WebSock client '+name+' is ready');

			ws_endpoint.Open();
			ws_protocol=ws_transport.NewProtocol(WSGuestEPN);
		},
		OnDisconnected:(agent,normal)=>{

			log.Info('WebSock client '+name+' is disconnected');

			ws_protocol.Release();
			ws_endpoint.Close();
		},
		OnReceived:(agent,msg)=>{

			ws_driver.Receive(msg);
		},
	}
	let client=YgEs.WebSockClient.SetUp(url,opt);
	return client.Fetch();
}

function gui_test_form(caption){

	YgEs.NewQHT({Target:mainboard,Tag:'h3',Attr:{class:'yges_testview_caption'},Sub:[caption]});
	return YgEs.NewQHT({Target:mainboard,Tag:'div',Attr:{class:'yges_testview_window'}});
}

function gui_test_echo(){

	const gui=gui_test_form('Echo');
	const gui_send=YgEs.NewQHT({Target:gui,Tag:'div'});
	const gui_recv=YgEs.NewQHT({Target:gui,Tag:'div'});

	gui_send.Append('SEND');
	gui_recv.Append('RECV');

	const content_send=YgEs.NewQHT({Target:gui_send,Tag:'input',Attr:{type:'text'},Style:{width:'70%',height:'1.2em','font-size':'100%'}});
	gui_echo_content_recv=YgEs.NewQHT({Target:gui_recv,Tag:'input',Attr:{type:'text',readonly:'readonly'},Style:{width:'70%',height:'1.2em','font-size':'100%'}});

	YgEs.GUI.Button(gui_send,'Send',{
		Class:'yges_testview_button',
		OnClick:(view)=>{
			log.Trace('try sending: '+content_send.Element.value);

//			ws_endpoint.Send(null,'ECHO_REQ',content_send.Element.value);
			ws_protocol.Send(null,'ECHO_REQ',content_send.Element.value);
		},
	});
}

async function ipl_ready(){

	ipl_loading.Remove();

	YgEs.InitFrontend(modules,mainboard);

	// resources 
	YgEs.LoadCSS('testview.css');
	YgEs.LoadCSS('logview.css');
	YgEs.LoadJS('yges/network.js');
	YgEs.LoadJS('yges/gui.js');
	YgEs.LoadJS('yges/logger_view.js');
	YgEs.LoadJS('yges/websock_client.js');
	await YgEs.LoadSync().ToPromise();
	YgEs.DisposeMonitor();

	// log view 
	log=YgEs.Log.CreateLocal('YgEsTest',YgEs.Log.LEVEL.TICK);
	let logviewarea=YgEs.NewQHT({Target:mainboard,Tag:'div',Attr:{class:'yges_logview_area'}});
	let logview=YgEs.LogView.SetUp(logviewarea,log,false);

	// WebSocket Transport 
	ws_driver=YgEs.Network.CreateDriver(drvopt);
	ws_transport=YgEs.Network.CreateTransport(tpopt);
	ws_transport.AttachReceiver('ws',ws_driver);
	ws_transport.AttachSender('ws',ws_driver);
	ws_transport.SetSelector((tp,target,prop)=>'ws');

	// WebSocket EndPoint 
	const epopt={
	}
	ws_endpoint=YgEs.Network.CreateEndPoint(epopt).Fetch();
	ws_transport.Connect(WSGuestEPN,ws_endpoint);

	// connect via WebSocket 
	ws_cli=ws_client_new('WebSockTestClient','ws://localhost:8801',100);
	ws_cli.Open();

	gui_test_echo();
}

//--></script></div></body></html>